#
#
# This file contains pipeline steps which run from the COVID19-ISRAEL private repository
#
# You can add additional steps using the same format
#
# Each step should have a unique ID
#
# Available attributes for each step:
#
# dependencies:
#
#   list of other step ids which must run before this step
#   you can refer to other steps in this file
#   or to the special steps:
#     corona_data_collector - runs every day at 02:00
#     github_pull_covid19_israel - will cause your pipeline to run only if there was a change in the COVID19-ISRAEL repository
#
#
# module:
#
#   module name in COVID19-ISRAEL repository
#   example of how a module is run from COVID19-ISRAEL repository:
#      python3 -m src.utils.get_raw_Data
#
#
# args:
#
#   list of additional args to pass to the module invocation
#   the args are appended to the python3 command
#   example of how a module is run from COVID19-ISRAEL repository:
#      python3 -m src.utils.lamas_features --if-not-exists
#
#


get_raw_data:
  dependencies:
    - corona_data_collector
    - github_pull_covid19_israel
  module: src.utils.get_raw_data


preprocess_raw_data:
  dependencies:
    - get_raw_data
  module: src.utils.preprocess_raw_data


lamas_features:
  dependencies:
    - preprocess_raw_data
  module: src.utils.lamas_features
  args: ["--if-not-exists"]


bayesian_correction:
  dependencies:
    - lamas_features
  module: src.bayesian.bayesian_correction
  args: ["--recompute"]


maps_generate_daily_summary:
  dependencies:
    - bayesian_correction
  module: src.utils.maps.generate_daily_summary
  external_sharing_packages:
    - package_path: out/external_sharing/HASADNA/datapackage.json
      publish_targets:
        - github_repo: hasadna/avid-covider-raw-data
          deploy_key: hasadna_avid_covider_raw_data
          files:
            daily_summary: "input/{POSTERIOR_DATE}.csv"
            cities_geojson: "geo/cities.geojson"
            neighborhoods_geojson: "geo/neighborhoods.geojson"


#idf_report_cities_by_week:
#  dependencies:
#    - bayesian_correction
#  module: src.idf_report.cities_by_week
#  args: ["--cities"]
#  external_sharing_packages:
#    - package_path: out/bayesian/idf/cities_by_week_datapackage.json
#      publish_targets:
#        - github_repo: hrossman/Covid19-Survey
#          deploy_key: hrossman_covid19_survey
#          files:
#            cities_csv: "aggregated_data/{recent_date}_cities_by_week.csv"


#idf_report_neighborhoods_by_week:
#  dependencies:
#    - bayesian_correction
#  module: src.idf_report.cities_by_week
#  args: ["--neighborhoods"]
#  external_sharing_packages:
#    - package_path: out/bayesian/idf/neighborhoods_by_week_datapackage.json
#      publish_targets:
#        - github_repo: hrossman/Covid19-Survey
#          deploy_key: hrossman_covid19_survey
#          files:
#            neighborhoods_csv: "aggregated_data/{recent_date}_neighborhoods_by_week.csv"


#idf_report:
#  dependencies:
#    - bayesian_correction
#  module: src.idf_report.idf_report
#  external_sharing_packages:
#    - package_path: out/bayesian/idf/datapackage.json
#      publish_targets:
#        - github_repo: hrossman/Covid19-Survey
#          deploy_key: hrossman_covid19_survey
#          files_foreach:
#            min_per_region_lst:
#              "min_per_region_{foreach_value}_html": "aggregated_data/{posterior_date}_min_per_region_{foreach_value}.html"
